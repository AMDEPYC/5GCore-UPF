From 30893ce1c6cc398717363b60ff87e4388d51d33f Mon Sep 17 00:00:00 2001
From: Sivaprasad Tummala <sivaprasad.tummala@amd.com>
Date: Tue, 21 Oct 2025 13:45:55 +0000
Subject: [PATCH 10/11] dpdk: add configurable empty poll threshold for power
 mgmt

This patch adds a new setting to control the maximum number
of empty polls for DPDK power management.

* Added `emptypoll_max` field with default value 64.
* Added CLI option `empty-polls <value>` to set this value.
* Applied the setting when power management is enabled using
  `rte_power_pmd_mgmt_set_emptypoll_max()`.

This helps fine tuning for better latency and power efficiency.

Signed-off-by: Sivaprasad Tummala <sivaprasad.tummala@amd.com>
---
 src/plugins/dpdk/device/dpdk.h | 1 +
 src/plugins/dpdk/device/init.c | 9 ++++++++-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/src/plugins/dpdk/device/dpdk.h b/src/plugins/dpdk/device/dpdk.h
index 33e12510c..9ad3df146 100644
--- a/src/plugins/dpdk/device/dpdk.h
+++ b/src/plugins/dpdk/device/dpdk.h
@@ -336,6 +336,7 @@ typedef struct
   /* Enable/disable DPDK powerâ€‘management */
   u8 dpdk_pm_enabled;
   enum rte_power_pmd_mgmt_type dpdk_pm_mode;
+  u16 emptypoll_max;
 } dpdk_main_t;
 
 extern dpdk_main_t dpdk_main;
diff --git a/src/plugins/dpdk/device/init.c b/src/plugins/dpdk/device/init.c
index 0a5ada6ec..ed90751c4 100644
--- a/src/plugins/dpdk/device/init.c
+++ b/src/plugins/dpdk/device/init.c
@@ -256,6 +256,9 @@ dpdk_lib_init (dpdk_main_t * dm)
       check_l3cache () == 0)
     dm->default_port_conf.n_rx_desc = dm->default_port_conf.n_tx_desc = 512;
 
+  if (dm->dpdk_pm_enabled)
+    rte_power_pmd_mgmt_set_emptypoll_max(dm->emptypoll_max);
+
   RTE_ETH_FOREACH_DEV (port_id)
     {
       u8 addr[6];
@@ -1059,6 +1062,8 @@ dpdk_config (vlib_main_t * vm, unformat_input_t * input)
       else if (unformat (input, "pmd-mgmt %U",
 			     unformat_dpdk_pm_mode, &dm->dpdk_pm_mode))
 	dm->dpdk_pm_enabled = 1;
+      else if (unformat (input, "empty-polls %u", &dm->emptypoll_max))
+	;
       else if (unformat (input, "dev default %U", unformat_vlib_cli_sub_input,
 			 &sub_input))
 	{
@@ -1374,7 +1379,8 @@ dpdk_config (vlib_main_t * vm, unformat_input_t * input)
     return error;
 
   if (dm->dpdk_pm_enabled)
-	  vlib_log_info(dm->log_default, "DPDK PM enabled: mode = %u", dm->dpdk_pm_mode);
+	  vlib_log_info(dm->log_default, "DPDK PM enabled: mode = %u emptypolls %u",
+			 dm->dpdk_pm_mode, dm->emptypoll_max);
   else
 	  vlib_log_info(dm->log_default, "DPDK PM disabled (default)");
 
@@ -1563,6 +1569,7 @@ dpdk_init (vlib_main_t * vm)
 
   dm->dpdk_pm_enabled = 0; /* disabled by default */
   dm->dpdk_pm_mode = RTE_POWER_MGMT_TYPE_MONITOR;  /* default */
+  dm->emptypoll_max = 64;  /* default */
 
   return error;
 }
-- 
2.34.1

